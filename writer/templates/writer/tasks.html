<!-- writer/templates/writer/tasks.html -->
{% extends 'base.html' %}
{% load static %}
{% block title %}Tasks - Writer{% endblock %}
{% block extra_css %}
<meta name="csrf-token" content="{{ csrf_token }}">
{% endblock %}
{% block content %}
{% csrf_token %}
<!-- Add this hidden input to ensure CSRF token is available -->
<input type="hidden" name="csrfmiddlewaretoken" value="{{ csrf_token }}" style="display: none;">
<div class="dashboard-header">
    <h1 class="dashboard-title">Tasks</h1>
    <p class="dashboard-subtitle">View and manage all your assigned projects</p>
</div>

<!-- Filters -->
<div class="card" style="margin-bottom: var(--spacing-lg);">
    <div class="card-body">
        <form method="GET" class="form-row" style="align-items: flex-end;">
            <div class="form-group" style="margin-bottom: 0;">
                <label class="form-label">Search</label>
                <input type="text" 
                       name="search" 
                       value="{{ search_query }}" 
                       class="form-control" 
                       placeholder="Search by Job ID or Topic...">
            </div>
            
            <div class="form-group" style="margin-bottom: 0;">
                <label class="form-label">Status</label>
                <select name="status" class="form-control form-select">
                    <option value="">All Status</option>
                    {% for value, label in STATUS_CHOICES %}
                    <option value="{{ value }}" {% if status_filter == value %}selected{% endif %}>
                        {{ label }}
                    </option>
                    {% endfor %}
                </select>
            </div>
            
            <div class="btn-group" style="margin-bottom: 0;">
                <button type="submit" class="btn btn-primary">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <circle cx="11" cy="11" r="8" stroke="currentColor" stroke-width="2"/>
                        <path d="M21 21L16.65 16.65" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                    </svg>
                    Filter
                </button>
                <a href="{% url 'writer_tasks' %}" class="btn btn-outline">
                    Clear
                </a>
            </div>
        </form>
    </div>
</div>

<!-- Tasks Table -->
<div class="card">
    <div class="card-header">
        <h2 class="card-title">Tasks List ({{ projects|length }})</h2>
    </div>
    <div class="card-body">
        <div class="table-container">
            <table class="data-table">
                <thead>
                    <tr>
                        <th>JOB ID</th>
                        <th>TOPIC</th>
                        <th>WORD COUNT</th>
                        <th>START DATE</th>
                        <th>END DATE</th>
                        <th>REFERENCING</th>
                        <th>STATUS</th>
                        <th>ACTION</th>
                    </tr>
                </thead>
                <tbody>
                    {% for project in projects %}
                    <tr id="task-row-{{ project.system_id }}">
                        <td>
                            <span style="font-weight: 600; color: var(--primary);">
                                {{ project.system_id }}
                            </span>
                        </td>
                        <td>
                            <span style="max-width: 300px; display: inline-block; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;" title="{{ project.topic }}">
                                {{ project.topic|default:"N/A" }}
                            </span>
                        </td>
                        <td>
                            <span style="font-weight: 600;">
                                {{ project.word_count|default:"N/A" }}
                            </span>
                        </td>
                        <td>
                            <span>
                                {{ project.start_date|date:"d M Y, h:i A"|default:"N/A" }}
                            </span>
                        </td>
                        <td>
                            <span>
                                {{ project.end_date|date:"d M Y, h:i A"|default:"N/A" }}
                            </span>
                        </td>
                        <td>
                            <span style="text-transform: uppercase; font-weight: 600; color: var(--secondary);">
                                {{ project.referencing_style|default:"N/A" }}
                            </span>
                        </td>
                        <td>
                            {% if project.status == 'allocated' %}
                            <span class="status-tag status-allocated">ALLOCATED</span>
                            {% elif project.status == 'in_progress' %}
                            <span class="status-tag status-in-progress">IN PROGRESS</span>
                            {% elif project.status == 'completed' %}
                            <span class="status-tag status-completed">COMPLETED</span>
                            {% elif project.status == 'hold' %}
                            <span class="status-tag status-hold">HOLD</span>
                            {% elif project.status == 'Review' %}
                            <span class="status-tag status-review">REVIEW</span>
                            {% endif %}
                        </td>
                        <td>
                            <div class="action-buttons">
                                <button onclick="openProjectModal('{{ project.system_id }}')" class="btn btn-outline btn-sm">
                                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                        <path d="M1 12C1 12 5 4 12 4C19 4 23 12 23 12C23 12 19 20 12 20C5 20 1 12 1 12Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                        <circle cx="12" cy="12" r="3" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                    </svg>
                                    View
                                </button>
                                <button onclick="{% if project.status == 'allocated' %}selectTask('{{ project.system_id }}', event){% else %}return false{% endif %}" class="btn btn-sm" id="select-btn-{{ project.system_id }}" style="display: inline-flex; align-items: center; gap: 6px; {% if project.status == 'allocated' %}background-color: var(--primary); color: white;{% else %}background-color: #ccc; color: #666; cursor: not-allowed;{% endif %}" {% if project.status != 'allocated' %}disabled{% endif %}>
                                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                        <path d="M9 11L12 14L22 4" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                        <path d="M21 12V19C21 19.5304 20.7893 20.0391 20.4142 20.4142C20.0391 20.7893 19.5304 21 19 21H5C4.46957 21 3.96086 20.7893 3.58579 20.4142C3.21071 20.0391 3 19.5304 3 19V5C3 4.46957 3.21071 3.96086 3.58579 3.58579C3.96086 3.21071 4.46957 3 5 3H16" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                    </svg>
                                    <span>{% if project.status == 'allocated' %}Select{% else %}Selected{% endif %}</span>
                                </button>
                            </div>
                        </td>
                    </tr>
                    
                    <!-- Expandable Submission Blocks Row -->
                    {% if project.status == 'in_progress' %}
                    <tr class="submission-row" id="submission-row-{{ project.system_id }}" style="display: none;">
                        <td colspan="8">
                            <div class="submission-container">
                                <div class="submission-blocks">
                                    <!-- Block 1: Structure -->
                                    <div class="submission-block">
                                        <div class="block-header">
                                            <h4>Block 1(Structure)</h4>
                                            <span class="block-status" id="structure-status-{{ project.system_id }}">Pending</span>
                                        </div>
                                        <div class="block-content">
                                            <p class="block-description">Submit your project structure with notes and file</p>
                                            <div class="block-actions">
                                                <button onclick="openStructureModal('{{ project.system_id }}')" class="btn btn-secondary" id="structure-btn-{{ project.system_id }}">
                                                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none">
                                                        <path d="M12 5V19M5 12H19" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                                                    </svg>
                                                    Upload Structure
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <!-- Block 2: Final Copy -->
                                    <div class="submission-block">
                                        <div class="block-header">
                                            <h4>Block 2(Final Copy)</h4>
                                            <span class="block-status" id="final-status-{{ project.system_id }}">Pending</span>
                                        </div>
                                        <div class="block-content">
                                            <p class="block-description">Submit your final copy with Proper notes and files (Example Report, PPT, Software, Video etc...)</p>
                                            <div class="block-actions">
                                                <button onclick="openFinalCopyModal('{{ project.system_id }}')" class="btn btn-secondary" id="final-btn-{{ project.system_id }}" disabled>
                                                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none">
                                                        <path d="M12 5V19M5 12H19" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                                                    </svg>
                                                    Submit Final File
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </td>
                    </tr>
                    {% endif %}
                    
                    {% empty %}
                    <tr>
                        <td colspan="8" class="text-center" style="padding: 3rem;">
                            <div style="opacity: 0.6;">
                                <svg width="64" height="64" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" style="margin-bottom: 1rem; opacity: 0.3;">
                                    <path d="M22 19C22 19.5304 21.7893 20.0391 21.4142 20.4142C21.0391 20.7893 20.5304 21 20 21H4C3.46957 21 2.96086 20.7893 2.58579 20.4142C2.21071 20.0391 2 19.5304 2 19V5C2 4.46957 2.21071 3.96086 2.58579 3.58579C2.96086 3.21071 3.46957 3 4 3H9L11 6H20C20.5304 6 21.0391 6.21071 21.4142 6.58579C21.7893 6.96086 22 7.46957 22 8V19Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                </svg>
                                <p style="font-size: 18px; font-weight: 600;">No Tasks Found</p>
                                <p style="font-size: 14px;">You don't have any tasks {% if status_filter %}with this status{% endif %} yet.</p>
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Structure Modal -->
<div id="structureModal" class="modal">
    <div class="modal-content modal-lg">
        <div class="modal-header">
            <h2>Submit Structure</h2>
            <span class="close" onclick="closeStructureModal()">&times;</span>
        </div>
        <form id="structureForm" onsubmit="submitStructure(event); return false;">
            <div class="modal-body">
                <input type="hidden" id="structure-system-id" name="system_id">
                
                <div class="form-group">
                    <label class="form-label" style="color: #333; font-weight: 600;">Note <span class="text-danger">*</span> <span id="structure-word-count" style="color: #666;">(0/250 words)</span></label>
                    <textarea id="structure-notes" name="notes" class="form-control" rows="6" maxlength="5000" required placeholder="Enter your structure notes here..."></textarea>
                </div>
                
                <div class="form-group">
                    <label class="form-label" style="color: #333; font-weight: 600;">Upload File <span class="text-danger">*</span></label>
                    <div class="file-upload-area" id="structure-file-area" style="color: #666;">
                        <!-- FIX THIS LINE - REMOVE multiple ATTRIBUTE -->
                        <input type="file" 
                               id="structure-files" 
                               name="files" 
                               accept=".pdf,.doc,.docx,.jpg,.jpeg,.png" 
                               style="display: none;">
                        
                        <button type="button" class="btn btn-outline" onclick="document.getElementById('structure-files').click()">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none">
                                <path d="M21 15V19C21 19.5304 20.7893 20.0391 20.4142 20.4142C20.0391 20.7893 19.5304 21 19 21H5C4.46957 21 3.96086 20.7893 3.58579 20.4142C3.21071 20.0391 3 19.5304 3 19V15M17 8L12 3M12 3L7 8M12 3V15" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                            </svg>
                            Upload File (1 file only)
                        </button>
                        <div id="structure-file-list" class="file-list"></div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-outline" onclick="closeStructureModal()">Cancel</button>
                <button type="submit" class="btn btn-primary">Submit Structure</button>
            </div>
        </form>
    </div>
</div>


<!-- Final Copy Modal -->
<div id="finalCopyModal" class="modal">
    <div class="modal-content modal-lg">
        <div class="modal-header">
            <h2>Submit Final Copy</h2>
            <span class="close" onclick="closeFinalCopyModal()">&times;</span>
        </div>
        <form id="finalCopyForm" onsubmit="submitFinalCopy(event); return false;">
            <div class="modal-body">
                <input type="hidden" id="final-system-id" name="system_id">
                
                <div class="form-group">
                    <label class="form-label" style="color: #333; font-weight: 600;">Notes <span class="text-danger">*</span> <span id="final-word-count" style="color: #666;">(0/3000 words)</span></label>
                    <textarea id="final-notes" name="notes" class="form-control" rows="12" required placeholder="Enter your final copy notes here..."></textarea>
                </div>
                
                <div class="form-group">
                    <label class="form-label" style="color: #333; font-weight: 600;">Upload Files</label>
                    <div class="file-upload-area" id="final-file-area" style="color: #666;">
                        <input type="file" id="final-files" name="files" multiple accept=".pdf,.doc,.docx,.jpg,.jpeg,.png" style="display: none;">
                        <button type="button" class="btn btn-outline" onclick="document.getElementById('final-files').click()">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none">
                                <path d="M21 15V19C21 19.5304 20.7893 20.0391 20.4142 20.4142C20.0391 20.7893 19.5304 21 19 21H5C4.46957 21 3.96086 20.7893 3.58579 20.4142C3.21071 20.0391 3 19.5304 3 19V15M17 8L12 3M12 3L7 8M12 3V15" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                            </svg>
                            Choose Files
                        </button>
                        <div id="final-file-list" class="file-list"></div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-outline" onclick="closeFinalCopyModal()">Cancel</button>
                <button type="submit" class="btn btn-primary">Submit Final Copy</button>
            </div>
        </form>
    </div>
</div>

<!-- Project Detail Modal (Same as all_projects.html) -->
<div id="projectModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2>Project Details</h2>
            <span class="close" onclick="closeProjectModal()">&times;</span>
        </div>
        <div class="modal-body" id="modalBody">
            <div class="loading-spinner">Loading...</div>
        </div>
    </div>
</div>

<style>
    /* Table Styles */
    .data-table tbody tr {
        transition: all 0.3s ease;
    }
    
    .data-table tbody tr:hover {
        background-color: rgba(183, 153, 255, 0.08);
    }
    
    .action-buttons {
        display: flex;
        gap: 8px;
        align-items: center;
    }
    
    .btn-sm {
        padding: 6px 12px;
        font-size: 13px;
        white-space: nowrap;
    }
    
    /* Submission Row Styles */
    .submission-row {
        background: #f8f9fa !important;
    }
    
    .submission-container {
        padding: 20px;
    }
    
    .submission-blocks {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
        gap: 20px;
    }
    
    .submission-block {
        border: 2px solid #e0e0e0;
        border-radius: 8px;
        padding: 20px;
        background: white;
    }
    
    .block-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 15px;
    }
    
    .block-header h4 {
        margin: 0;
        font-size: 16px;
        color: var(--primary);
    }
    
    .block-status {
        padding: 4px 12px;
        border-radius: 12px;
        font-size: 12px;
        font-weight: 600;
        background: #ffc107;
        color: #000;
    }
    
    .block-status.completed {
        background: #4caf50;
        color: white;
    }
    
    .block-content {
        margin-bottom: 15px;
    }
    
    .block-description {
        color: #666;
        font-size: 14px;
        margin-bottom: 15px;
    }
    
    .block-actions {
        display: flex;
        gap: 10px;
    }
    
    /* Modal Styles */
    .modal {
        display: none;
        position: fixed;
        z-index: 1000;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        overflow: auto;
        background-color: rgba(0, 0, 0, 0.5);
        animation: fadeIn 0.3s;
    }
    
    @keyframes fadeIn {
        from { opacity: 0; }
        to { opacity: 1; }
    }
    
    .modal-content {
        background-color: #fff;
        margin: 2% auto;
        padding: 0;
        border-radius: 12px;
        width: 90%;
        max-width: 1000px;
        max-height: 90vh;
        overflow: hidden;
        box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
        animation: slideDown 0.3s;
    }
    
    @keyframes slideDown {
        from {
            transform: translateY(-50px);
            opacity: 0;
        }
        to {
            transform: translateY(0);
            opacity: 1;
        }
    }
    
    .modal-lg {
        max-width: 800px;
    }
    
    .modal-header {
        padding: 20px 30px;
        background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
        color: white;
        display: flex;
        justify-content: space-between;
        align-items: center;
        border-bottom: 1px solid #eee;
    }
    
    .modal-header h2 {
        margin: 0;
        font-size: 24px;
        font-weight: 600;
    }
    
    .close {
        color: white;
        font-size: 32px;
        font-weight: bold;
        cursor: pointer;
        transition: all 0.3s;
        line-height: 1;
    }
    
    .close:hover {
        transform: rotate(90deg);
    }
    
    .modal-body {
        padding: 30px;
        max-height: calc(90vh - 160px);
        overflow-y: auto;
    }
    
    .modal-footer {
        padding: 20px 30px;
        border-top: 1px solid #eee;
        display: flex;
        justify-content: flex-end;
        gap: 10px;
    }
    
    .file-upload-area {
        border: 2px dashed #ddd;
        border-radius: 8px;
        padding: 20px;
        text-align: center;
    }
    
    .file-list {
        margin-top: 15px;
        text-align: left;
    }
    
    .file-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 10px;
        background: #f5f5f5;
        border-radius: 4px;
        margin-bottom: 8px;
    }
    
    .file-item-name {
        flex: 1;
        font-size: 14px;
        color: #333;
    }
    
    .file-item-remove {
        color: #d32f2f;
        cursor: pointer;
        font-size: 18px;
    }
    
    .text-danger {
        color: #d32f2f;
    }
    
    .loading-spinner {
        text-align: center;
        padding: 40px;
        font-size: 18px;
        color: var(--primary);
    }
    
    /* Status Tags */
    .status-tag {
        display: inline-block;
        padding: 6px 12px;
        border-radius: 20px;
        font-size: 12px;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }
    
    .status-allocated { 
        background: #e3f2fd; 
        color: #1976d2; 
    }
    
    .status-in-progress { 
        background: #fff3e0; 
        color: #f57c00; 
    }
    
    .status-completed { 
        background: #e8f5e9; 
        color: #388e3c; 
    }
    
    .status-hold { 
        background: #fce4ec; 
        color: #c2185b; 
    }
    
    .status-review { 
        background: #f3e5f5; 
        color: #7b1fa2; 
    }
    
    /* Detail section styles (for view modal) */
    .detail-section {
        margin-bottom: 30px;
        padding: 20px;
        background: #f8f9fa;
        border-radius: 8px;
        border-left: 4px solid var(--primary);
    }
    
    .detail-section h3 {
        margin-top: 0;
        margin-bottom: 15px;
        color: var(--primary);
        font-size: 18px;
        font-weight: 600;
    }
    
    .detail-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 15px;
    }
    
    .detail-item {
        display: flex;
        flex-direction: column;
    }
    
    .detail-label {
        font-weight: 600;
        color: #666;
        font-size: 13px;
        margin-bottom: 5px;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }
    
    .detail-value {
        color: #333;
        font-size: 15px;
        font-weight: 500;
    }
    
    .attachment-list {
        list-style: none;
        padding: 0;
        margin: 10px 0 0 0;
    }
    
    .attachment-item {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 12px;
        background: white;
        border-radius: 6px;
        margin-bottom: 10px;
        transition: all 0.3s;
        border: 1px solid #e0e0e0;
    }
    
    .attachment-item:hover {
        background: #f0f0f0;
        border-color: var(--primary);
    }
    
    .attachment-info {
        display: flex;
        align-items: center;
        flex: 1;
        min-width: 0;
    }
    
    .attachment-icon {
        margin-right: 12px;
        color: var(--primary);
        flex-shrink: 0;
    }
    
    .attachment-details {
        display: flex;
        flex-direction: column;
        min-width: 0;
        flex: 1;
    }
    
    .attachment-name {
        color: #333;
        font-weight: 500;
        font-size: 14px;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }
    
    .attachment-size {
        color: #999;
        font-size: 12px;
        margin-top: 2px;
    }
    
    .attachment-download {
        margin-left: 15px;
        flex-shrink: 0;
    }
    
    .download-btn {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        padding: 8px 16px;
        background: var(--primary);
        color: white;
        border: none;
        border-radius: 6px;
        font-size: 13px;
        font-weight: 600;
        cursor: pointer;
        text-decoration: none;
        transition: all 0.3s;
    }
    
    .download-btn:hover {
        background: var(--secondary);
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    }
    
    .download-btn svg {
        width: 16px;
        height: 16px;
    }
    
    .error-message {
        text-align: center;
        padding: 40px;
        color: #d32f2f;
        font-size: 16px;
    }
</style>

<script>
// Task selection - Auto select without confirmation
function selectTask(systemId, event) {
    if (event) {
        event.preventDefault();
    }
    
    const selectBtn = document.getElementById('select-btn-' + systemId);
    if (!selectBtn) {
        console.error('Select button not found for system_id:', systemId);
        return;
    }
    
    selectBtn.disabled = true;
    selectBtn.innerHTML = '<span>Processing...</span>';
    
    const csrfToken = getCookie('csrftoken');
    const url = '/writer/task/' + systemId + '/select/';
    
    fetch(url, {
        method: 'POST',
        headers: {
            'X-CSRFToken': csrfToken,
            'Content-Type': 'application/json',
            'Accept': 'application/json'
        },
        credentials: 'same-origin',
        body: JSON.stringify({})
    })
    .then(response => {
        if (!response.ok) {
            return response.json().then(data => {
                throw new Error(data.error || 'Server error (Status: ' + response.status + ')');
            }).catch(err => {
                if (err.message.includes('Server error')) {
                    throw err;
                }
                throw new Error('Server returned status: ' + response.status);
            });
        }
        return response.json();
    })
    .then(data => {
        if (data.success) {
            location.reload();
        } else {
            throw new Error(data.error || 'Unknown error');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Error: ' + error.message);
        selectBtn.disabled = false;
        selectBtn.innerHTML = '<svg width="14" height="14" viewBox="0 0 24 24" fill="none"><path d="M9 11L12 14L22 4" stroke="currentColor" stroke-width="2"/><path d="M21 12V19C21 19.5304 20.7893 20.0391 20.4142 20.4142C20.0391 20.7893 19.5304 21 19 21H5C4.46957 21 3.96086 20.7893 3.58579 20.4142C3.21071 20.0391 3 19.5304 3 19V5C3 4.46957 3.21071 3.96086 3.58579 3.58579C3.96086 3.21071 4.46957 3 5 3H16" stroke="currentColor" stroke-width="2"/></svg><span>Select</span>';
    });
}

// Toggle submission blocks visibility
function toggleSubmissionBlocks(systemId) {
    const submissionRow = document.getElementById(`submission-row-${systemId}`);
    if (submissionRow) {
        const isVisible = submissionRow.style.display !== 'none';
        submissionRow.style.display = isVisible ? 'none' : 'table-row';
        
        if (!isVisible) {
            loadSubmissionDetails(systemId);
        }
    }
}

// Load submission details
function loadSubmissionDetails(systemId) {
    fetch(`/writer/task/${systemId}/submission-details/`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Update structure status
                if (data.structure) {
                    document.getElementById(`structure-status-${systemId}`).textContent = 'Completed';
                    document.getElementById(`structure-status-${systemId}`).classList.add('completed');
                    document.getElementById(`structure-btn-${systemId}`).innerHTML = `
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none">
                            <path d="M11 4H4C3.46957 4 2.96086 4.21071 2.58579 4.58579C2.21071 4.96086 2 5.46957 2 6V20C2 20.5304 2.21071 21.0391 2.58579 21.4142C2.96086 21.7893 3.46957 22 4 22H18C18.5304 22 19.0391 21.7893 19.4142 21.4142C19.7893 21.0391 20 20.5304 20 20V13" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                            <path d="M18.5 2.5C18.8978 2.10217 19.4374 1.87868 20 1.87868C20.5626 1.87868 21.1022 2.10217 21.5 2.5C21.8978 2.89782 22.1213 3.43739 22.1213 4C22.1213 4.56261 21.8978 5.10217 21.5 5.5L12 15L8 16L9 12L18.5 2.5Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                        </svg>
                        Edit Structure
                    `;
                    
                    // Enable final copy button
                    document.getElementById(`final-btn-${systemId}`).disabled = false;
                }
                
                // Update final copy status
                if (data.final_copy) {
                    document.getElementById(`final-status-${systemId}`).textContent = 'Completed';
                    document.getElementById(`final-status-${systemId}`).classList.add('completed');
                    document.getElementById(`final-btn-${systemId}`).disabled = true;
                }
            }
        })
        .catch(error => console.error('Error loading submission details:', error));
}

// Structure Modal
function openStructureModal(systemId) {
    document.getElementById('structure-system-id').value = systemId;
    document.getElementById('structureModal').style.display = 'block';
    document.getElementById('structure-notes').value = '';
    document.getElementById('structure-file-list').innerHTML = '';
    document.getElementById('structure-files').value = '';
    
    // Load existing submission data if available
    fetch(`/writer/task/${systemId}/submission-details/`)
        .then(response => response.json())
        .then(data => {
            if (data.success && data.structure) {
                // Populate notes
                document.getElementById('structure-notes').value = data.structure.notes;
                
                // Update word count
                const wordCount = data.structure.notes.trim().split(/\s+/).filter(word => word.length > 0).length;
                document.getElementById('structure-word-count').textContent = `(${wordCount}/250 words)`;
                
                // Show existing files
                const fileList = document.getElementById('structure-file-list');
                fileList.innerHTML = '';
                if (data.structure.files && data.structure.files.length > 0) {
                    data.structure.files.forEach(file => {
                        const fileItem = document.createElement('div');
                        fileItem.className = 'file-item';
                        fileItem.innerHTML = `
                            <span class="file-item-name">${file.filename}</span>
                            <span style="color: #999; font-size: 12px;">${file.size}</span>
                        `;
                        fileList.appendChild(fileItem);
                    });
                    
                    // Add note that selecting a new file will replace the existing one
                    const note = document.createElement('div');
                    note.style.cssText = 'margin-top: 10px; padding: 10px; background: #e3f2fd; border-radius: 4px; font-size: 13px; color: #1976d2;';
                    note.textContent = 'üí° Selecting a new file will replace the existing one.';
                    fileList.appendChild(note);
                }
            }
        })
        .catch(error => console.error('Error loading submission data:', error));
}

function closeStructureModal() {
    document.getElementById('structureModal').style.display = 'none';
}

// Final Copy Modal
function openFinalCopyModal(systemId) {
    document.getElementById('final-system-id').value = systemId;
    document.getElementById('finalCopyModal').style.display = 'block';
    document.getElementById('final-notes').value = '';
    document.getElementById('final-file-list').innerHTML = '';
    document.getElementById('final-files').value = '';
    
    // Load existing submission data if available
    fetch(`/writer/task/${systemId}/submission-details/`)
        .then(response => response.json())
        .then(data => {
            if (data.success && data.final_copy) {
                // Populate notes
                document.getElementById('final-notes').value = data.final_copy.notes;
                
                // Update word count
                const wordCount = data.final_copy.notes.trim().split(/\s+/).filter(word => word.length > 0).length;
                document.getElementById('final-word-count').textContent = `(${wordCount}/3000 words)`;
                
                // Show existing files
                const fileList = document.getElementById('final-file-list');
                fileList.innerHTML = '';
                if (data.final_copy.files && data.final_copy.files.length > 0) {
                    data.final_copy.files.forEach(file => {
                        const fileItem = document.createElement('div');
                        fileItem.className = 'file-item';
                        fileItem.innerHTML = `
                            <span class="file-item-name">${file.filename}</span>
                            <span style="color: #999; font-size: 12px;">${file.size}</span>
                        `;
                        fileList.appendChild(fileItem);
                    });
                    
                    // Add note that selecting new files will replace all existing ones
                    const note = document.createElement('div');
                    note.style.cssText = 'margin-top: 10px; padding: 10px; background: #e3f2fd; border-radius: 4px; font-size: 13px; color: #1976d2;';
                    note.textContent = 'üí° Selecting new files will replace all existing files.';
                    fileList.appendChild(note);
                }
            }
        })
        .catch(error => console.error('Error loading submission data:', error));
}

function closeFinalCopyModal() {
    document.getElementById('finalCopyModal').style.display = 'none';
}

// Word count tracking
document.getElementById('structure-notes')?.addEventListener('input', function() {
    const wordCount = this.value.trim().split(/\s+/).filter(word => word.length > 0).length;
    document.getElementById('structure-word-count').textContent = `(${wordCount}/250 words)`;
    if (wordCount > 250) {
        document.getElementById('structure-word-count').style.color = 'red';
    } else {
        document.getElementById('structure-word-count').style.color = '';
    }
});

document.getElementById('final-notes')?.addEventListener('input', function() {
    const wordCount = this.value.trim().split(/\s+/).filter(word => word.length > 0).length;
    document.getElementById('final-word-count').textContent = `(${wordCount}/3000 words)`;
    if (wordCount > 3000) {
        document.getElementById('final-word-count').style.color = 'red';
    } else {
        document.getElementById('final-word-count').style.color = '';
    }
});

// File handling
document.getElementById('structure-files')?.addEventListener('change', function() {
    handleFileSelection(this, 'structure-file-list', 1);  // Only 1 file for structure
});

document.getElementById('final-files')?.addEventListener('change', function() {
    handleFileSelection(this, 'final-file-list', 20);
});

function handleFileSelection(input, listId, maxFiles) {
    const fileList = document.getElementById(listId);
    const files = Array.from(input.files);
    
    // For structure, only allow 1 file
    if (maxFiles === 1 && files.length > 1) {
        alert('Please select only 1 file for structure submission');
        input.value = '';
        fileList.innerHTML = '';
        return;
    }
    
    if (files.length > maxFiles) {
        alert(`Maximum ${maxFiles} file(s) allowed`);
        input.value = '';
        fileList.innerHTML = '';
        return;
    }
    
    fileList.innerHTML = '';
    files.forEach((file, index) => {
        const fileItem = document.createElement('div');
        fileItem.className = 'file-item';
        fileItem.innerHTML = `
            <span class="file-item-name">${file.name}</span>
            <span class="file-item-remove" onclick="removeFile('${input.id}', ${index})">&times;</span>
        `;
        fileList.appendChild(fileItem);
    });
}

function removeFile(inputId, index) {
    const input = document.getElementById(inputId);
    const dt = new DataTransfer();
    const files = Array.from(input.files);
    
    files.forEach((file, i) => {
        if (i !== index) {
            dt.items.add(file);
        }
    });
    
    input.files = dt.files;
    input.dispatchEvent(new Event('change'));
}
let isSubmittingStructure = false;

// Submit Structure - FIXED VERSION
function submitStructure(event) {
    event.preventDefault();
    
    // Prevent double submission
    if (isSubmittingStructure) {
        console.log('Already submitting, please wait...');
        return false;
    }
    
    const systemId = document.getElementById('structure-system-id').value;
    const notes = document.getElementById('structure-notes').value.trim();
    const fileInput = document.getElementById('structure-files');
    const files = fileInput.files;
    
    console.log('=== Structure Submission Debug ===');
    console.log('System ID:', systemId);
    console.log('Notes length:', notes.length);
    console.log('Files count:', files.length);
    
    if (files.length > 0) {
        console.log('File details:');
        for (let i = 0; i < files.length; i++) {
            console.log(`  File ${i}: ${files[i].name} (${files[i].size} bytes, ${files[i].type})`);
        }
    }
    
    // Validate file selection
    if (!files || files.length === 0) {
        alert('Please select a file to upload');
        return false;
    }
    
    if (files.length > 1) {
        alert('Please select only 1 file');
        return false;
    }
    
    // Validate notes
    const wordCount = notes.split(/\s+/).filter(word => word.length > 0).length;
    if (wordCount > 250) {
        alert('Notes exceed 250 words limit. Current: ' + wordCount + ' words');
        return false;
    }
    
    if (!notes) {
        alert('Notes are required');
        return false;
    }
    
    // Validate file size (10MB limit)
    const maxSize = 10 * 1024 * 1024; // 10MB
    if (files[0].size > maxSize) {
        alert('File size exceeds 10MB limit. Your file: ' + (files[0].size / (1024 * 1024)).toFixed(2) + 'MB');
        return false;
    }
    
    // Validate file type
    const allowedExtensions = ['.pdf', '.doc', '.docx', '.jpg', '.jpeg', '.png'];
    const fileName = files[0].name.toLowerCase();
    const fileExtension = fileName.substring(fileName.lastIndexOf('.'));
    
    if (!allowedExtensions.includes(fileExtension)) {
        alert('Invalid file type: ' + fileExtension + '\nAllowed: ' + allowedExtensions.join(', '));
        return false;
    }
    
    isSubmittingStructure = true;
    
    // Create fresh FormData
    const formData = new FormData();
    formData.append('notes', notes);
    // Append only the file without extra filename parameter
    formData.append('files', files[0]);
    
    console.log('FormData created:');
    console.log('  - notes:', notes.substring(0, 50) + '...');
    console.log('  - file:', files[0].name, '(' + files[0].size + ' bytes)');
    
    const url = '/writer/task/' + systemId + '/submit-structure/';
    console.log('Submitting to URL:', url);
    
    // Disable submit button
    const submitBtn = event.target.querySelector('button[type="submit"]');
    const originalBtnText = submitBtn ? submitBtn.innerHTML : '';
    if (submitBtn) {
        submitBtn.disabled = true;
        submitBtn.innerHTML = '<span>Submitting...</span>';
    }
    
    fetch(url, {
        method: 'POST',
        headers: {
            'X-CSRFToken': getCookie('csrftoken'),
            // Don't set Content-Type - let browser set it with boundary
        },
        credentials: 'same-origin',
        body: formData
    })
    .then(response => {
        console.log('Response status:', response.status);
        console.log('Response headers:', response.headers);
        return response.json().then(data => ({
            status: response.status,
            data: data
        }));
    })
    .then(({status, data}) => {
        console.log('Response data:', data);
        
        if (data.success) {
            alert(data.message);
            console.log('File saved:', data.file_saved);
            closeStructureModal();
            location.reload();
        } else {
            alert('Error: ' + (data.error || 'Failed to submit structure'));
            isSubmittingStructure = false;
            if (submitBtn) {
                submitBtn.disabled = false;
                submitBtn.innerHTML = originalBtnText;
            }
        }
    })
    .catch(error => {
        console.error('Fetch error:', error);
        alert('An error occurred while submitting: ' + error.message);
        isSubmittingStructure = false;
        if (submitBtn) {
            submitBtn.disabled = false;
            submitBtn.innerHTML = originalBtnText;
        }
    });
    
    return false;
}

// Helper function to get CSRF token
function getCookie(name) {
    let cookieValue = null;
    
    // Method 1: Try to get from cookie
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    
    // Method 2: Try to get from meta tag
    if (!cookieValue && name === 'csrftoken') {
        const metaTag = document.querySelector('meta[name="csrf-token"]');
        if (metaTag) {
            cookieValue = metaTag.getAttribute('content');
        }
    }
    
    // Method 3: Try to get from hidden input
    if (!cookieValue && name === 'csrftoken') {
        const csrfInput = document.querySelector('[name=csrfmiddlewaretoken]');
        if (csrfInput) {
            cookieValue = csrfInput.value;
        }
    }
    
    console.log('CSRF Token:', cookieValue ? 'Found' : 'Not found');
    return cookieValue;
}


let isSubmittingFinalCopy = false;

// Submit Final Copy
function submitFinalCopy(event) {
    event.preventDefault();
    
    // Prevent double submission
    if (isSubmittingFinalCopy) {
        console.log('Already submitting, please wait...');
        return false;
    }
    
    isSubmittingFinalCopy = true;
    
    const systemId = document.getElementById('final-system-id').value;
    const formData = new FormData(document.getElementById('finalCopyForm'));
    
    const files = document.getElementById('final-files').files;
    
    // Clear any existing file entries first
    formData.delete('files');
    
    // Add files
    for (let i = 0; i < files.length; i++) {
        formData.append('files', files[i]);
    }
    
    const url = '/writer/task/' + systemId + '/submit-final-copy/';
    
    // Disable submit button
    const submitBtn = event.target.querySelector('button[type="submit"]');
    if (submitBtn) {
        submitBtn.disabled = true;
        submitBtn.textContent = 'Submitting...';
    }
    
    fetch(url, {
        method: 'POST',
        headers: {
            'X-CSRFToken': getCookie('csrftoken')
        },
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert(data.message);
            closeFinalCopyModal();
            location.reload();
        } else {
            alert(data.error || 'Failed to submit final copy');
            isSubmittingFinalCopy = false;
            if (submitBtn) {
                submitBtn.disabled = false;
                submitBtn.textContent = 'Submit Final Copy';
            }
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('An error occurred');
        isSubmittingFinalCopy = false;
        if (submitBtn) {
            submitBtn.disabled = false;
            submitBtn.textContent = 'Submit Final Copy';
        }
    });
    
    return false;
}
// Project Detail Modal (Same as all_projects.html)
function openProjectModal(systemId) {
    const modal = document.getElementById('projectModal');
    const modalBody = document.getElementById('modalBody');
    
    modal.style.display = 'block';
    modalBody.innerHTML = '<div class="loading-spinner">Loading project details...</div>';
    
    fetch(`/writer/project-detail-ajax/${systemId}/`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                modalBody.innerHTML = buildModalContent(data);
            } else {
                modalBody.innerHTML = '<div class="error-message">Error loading project details.</div>';
            }
        })
        .catch(error => {
            console.error('Error:', error);
            modalBody.innerHTML = '<div class="error-message">Error loading project details.</div>';
        });
}

function closeProjectModal() {
    document.getElementById('projectModal').style.display = 'none';
}

function buildModalContent(data) {
    const job = data.job;
    const allocation = data.allocation;
    const attachments = data.attachments;
    
    let html = `
        <!-- Job Information -->
        <div class="detail-section">
            <h3>üìã Job Information</h3>
            <div class="detail-grid">
                <div class="detail-item">
                    <span class="detail-label">Job ID</span>
                    <span class="detail-value">${job.system_id}</span>
                </div>
                <div class="detail-item">
                    <span class="detail-label">Status</span>
                    <span class="detail-value">
                        <span class="status-badge status-${job.status.toLowerCase().replace('_', '-')}">${job.status_display}</span>
                    </span>
                </div>
                <div class="detail-item">
                    <span class="detail-label">Category</span>
                    <span class="detail-value">${job.category || 'N/A'}</span>
                </div>
            </div>
        </div>
        <!-- Project Details -->
        <div class="detail-section">
            <h3>üìù Project Details</h3>
            <div class="detail-grid">
                <div class="detail-item">
                    <span class="detail-label">Topic</span>
                    <span class="detail-value">${job.topic || 'N/A'}</span>
                </div>
                <div class="detail-item">
                    <span class="detail-label">Word Count</span>
                    <span class="detail-value">${job.word_count || 'N/A'}</span>
                </div>
                <div class="detail-item">
                    <span class="detail-label">Referencing Style</span>
                    <span class="detail-value">${job.referencing_style_display || 'N/A'}</span>
                </div>
                <div class="detail-item">
                    <span class="detail-label">Writing Style</span>
                    <span class="detail-value">${job.writing_style_display || 'N/A'}</span>
                </div>
                <div class="detail-item">
                    <span class="detail-label">Software</span>
                    <span class="detail-value">${job.software || 'N/A'}</span>
                </div>
            </div>
            <div class="detail-item" style="margin-top: 15px;">
                <span class="detail-label">Instructions</span>
                <span class="detail-value">${job.instruction || 'N/A'}</span>
            </div>
        </div>
        <!-- Allocation Details -->
        <div class="detail-section">
            <h3>Allocation Details</h3>
            <div class="detail-grid">
                <div class="detail-item">
                    <span class="detail-label">Allocated By</span>
                    <span class="detail-value">${allocation.allocated_by_name}</span>
                </div>
                <div class="detail-item">
                    <span class="detail-label">Start Date</span>
                    <span class="detail-value">${allocation.start_date}</span>
                </div>
                <div class="detail-item">
                    <span class="detail-label">End Date</span>
                    <span class="detail-value">${allocation.end_date}</span>
                </div>
                <div class="detail-item">
                    <span class="detail-label">Allocated At</span>
                    <span class="detail-value">${allocation.allocated_at}</span>
                </div>
            </div>
            ${allocation.notes ? `
            <div class="detail-item" style="margin-top: 15px;">
                <span class="detail-label">Notes</span>
                <span class="detail-value">${allocation.notes}</span>
            </div>
            ` : ''}
        </div>
    `;
    
    // Add attachments section if there are any
    if (attachments && attachments.length > 0) {
        html += `
        <div class="detail-section">
            <h3>üìé Attachments (${attachments.length})</h3>
            <ul class="attachment-list">
        `;
        
        attachments.forEach(attachment => {
            html += `
                <li class="attachment-item">
                    <div class="attachment-info">
                        <svg class="attachment-icon" width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <path d="M13 2H6C5.46957 2 4.96086 2.21071 4.58579 4.58579C4.21071 2.96086 4 3.46957 4 4V20C4 20.5304 4.21071 21.0391 4.58579 21.4142C4.96086 21.7893 5.46957 22 6 22H18C18.5304 22 19.0391 21.7893 19.4142 21.4142C19.7893 21.0391 20 20.5304 20 20V9L13 2Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                            <path d="M13 2V9H20" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                        </svg>
                        <div class="attachment-details">
                            <span class="attachment-name" title="${attachment.original_filename}">${attachment.original_filename}</span>
                            <span class="attachment-size">${attachment.file_size}</span>
                        </div>
                    </div>
                    <div class="attachment-download">
                        <a href="${attachment.file_url}" download class="download-btn">
                            <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                <path d="M21 15V19C21 19.5304 20.7893 20.0391 20.4142 20.4142C20.0391 20.7893 19.5304 21 19 21H5C4.46957 21 3.96086 20.7893 3.58579 20.4142C3.21071 20.0391 3 19.5304 3 19V15" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                <path d="M7 10L12 15L17 10" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                <path d="M12 15V3" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                            </svg>
                            Download
                        </a>
                    </div>
                </li>
            `;
        });
        
        html += `
            </ul>
        </div>
        `;
    }
    
    return html;
}

// Helper function to get CSRF token with multiple fallback methods
function getCookie(name) {
    let cookieValue = null;
    
    // Method 1: Try to get from cookie
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    
    // Method 2: Try to get from meta tag
    if (!cookieValue && name === 'csrftoken') {
        const metaTag = document.querySelector('meta[name="csrf-token"]');
        if (metaTag) {
            cookieValue = metaTag.getAttribute('content');
        }
    }
    
    // Method 3: Try to get from hidden input
    if (!cookieValue && name === 'csrftoken') {
        const csrfInput = document.querySelector('[name=csrfmiddlewaretoken]');
        if (csrfInput) {
            cookieValue = csrfInput.value;
        }
    }
    
    return cookieValue;
}


function loadSubmissionDetails(systemId) {
    const url = '/writer/task/' + systemId + '/submission-details/';
    
    fetch(url)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                const structureStatus = document.getElementById('structure-status-' + systemId);
                const structureBtn = document.getElementById('structure-btn-' + systemId);
                const finalStatus = document.getElementById('final-status-' + systemId);
                const finalBtn = document.getElementById('final-btn-' + systemId);
                
                // Update structure status
                if (data.structure && structureStatus && structureBtn) {
                    structureStatus.textContent = 'Completed';
                    structureStatus.classList.add('completed');
                    structureBtn.innerHTML = '<svg width="16" height="16" viewBox="0 0 24 24" fill="none"><path d="M11 4H4C3.46957 4 2.96086 4.21071 2.58579 4.58579C2.21071 4.96086 2 5.46957 2 6V20C2 20.5304 2.21071 21.0391 2.58579 21.4142C2.96086 21.7893 3.46957 22 4 22H18C18.5304 22 19.0391 21.7893 19.4142 21.4142C19.7893 21.0391 20 20.5304 20 20V13" stroke="currentColor" stroke-width="2"/><path d="M18.5 2.5C18.8978 2.10217 19.4374 1.87868 20 1.87868C20.5626 1.87868 21.1022 2.10217 21.5 2.5C21.8978 2.89782 22.1213 3.43739 22.1213 4C22.1213 4.56261 21.8978 5.10217 21.5 5.5L12 15L8 16L9 12L18.5 2.5Z" stroke="currentColor" stroke-width="2"/></svg> Edit Structure';
                    
                    // Enable final copy button
                    if (finalBtn) {
                        finalBtn.disabled = false;
                    }
                }
                
                // Update final copy status
                if (data.final_copy && finalStatus && finalBtn) {
                    finalStatus.textContent = 'Completed';
                    finalStatus.classList.add('completed');
                    finalBtn.disabled = true;
                }
            }
        })
        .catch(error => console.error('Error loading submission details:', error));
}

// Word count tracking
const structureNotesEl = document.getElementById('structure-notes');
if (structureNotesEl) {
    structureNotesEl.addEventListener('input', function() {
        const wordCount = this.value.trim().split(/\s+/).filter(word => word.length > 0).length;
        const counter = document.getElementById('structure-word-count');
        counter.textContent = '(' + wordCount + '/250 words)';
        counter.style.color = wordCount > 250 ? 'red' : '';
    });
}

const finalNotesEl = document.getElementById('final-notes');
if (finalNotesEl) {
    finalNotesEl.addEventListener('input', function() {
        const wordCount = this.value.trim().split(/\s+/).filter(word => word.length > 0).length;
        const counter = document.getElementById('final-word-count');
        counter.textContent = '(' + wordCount + '/3000 words)';
        counter.style.color = wordCount > 3000 ? 'red' : '';
    });
}

// File handling
const structureFilesEl = document.getElementById('structure-files');
if (structureFilesEl) {
    structureFilesEl.addEventListener('change', function() {
        handleFileSelection(this, 'structure-file-list', 1);
    });
}

const finalFilesEl = document.getElementById('final-files');
if (finalFilesEl) {
    finalFilesEl.addEventListener('change', function() {
        handleFileSelection(this, 'final-file-list', 20);
    });
}

function handleFileSelection(input, listId, maxFiles) {
    const fileList = document.getElementById(listId);
    const files = Array.from(input.files);
    
    if (files.length > maxFiles) {
        alert('Maximum ' + maxFiles + ' files allowed');
        input.value = '';
        return;
    }
    
    fileList.innerHTML = '';
    files.forEach(function(file, index) {
        const fileItem = document.createElement('div');
        fileItem.className = 'file-item';
        fileItem.innerHTML = '<span class="file-item-name">' + file.name + '</span><span class="file-item-remove" onclick="removeFile(\'' + input.id + '\', ' + index + ')">&times;</span>';
        fileList.appendChild(fileItem);
    });
}

function removeFile(inputId, index) {
    const input = document.getElementById(inputId);
    const dt = new DataTransfer();
    const files = Array.from(input.files);
    
    files.forEach(function(file, i) {
        if (i !== index) {
            dt.items.add(file);
        }
    });
    
    input.files = dt.files;
    input.dispatchEvent(new Event('change'));
}

// Project Detail Modal
function openProjectModal(systemId) {
    const modal = document.getElementById('projectModal');
    const modalBody = document.getElementById('modalBody');
    
    modal.style.display = 'block';
    modalBody.innerHTML = '<div class="loading-spinner">Loading project details...</div>';
    
    const url = '/writer/project-detail-ajax/' + systemId + '/';
    
    fetch(url)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                modalBody.innerHTML = buildModalContent(data);
            } else {
                modalBody.innerHTML = '<div class="error-message">Error loading project details.</div>';
            }
        })
        .catch(error => {
            console.error('Error:', error);
            modalBody.innerHTML = '<div class="error-message">Error loading project details.</div>';
        });
}

function closeProjectModal() {
    document.getElementById('projectModal').style.display = 'none';
}

function buildModalContent(data) {
    const job = data.job;
    const allocation = data.allocation;
    const attachments = data.attachments;
    
    let html = '<div class="detail-section"><h3>Job Information</h3><div class="detail-grid">';
    html += '<div class="detail-item"><span class="detail-label">Job ID</span><span class="detail-value">' + job.system_id + '</span></div>';
    html += '<div class="detail-item"><span class="detail-label">Status</span><span class="detail-value"><span class="status-badge status-' + job.status.toLowerCase().replace('_', '-') + '">' + job.status_display + '</span></span></div>';
    html += '<div class="detail-item"><span class="detail-label">Category</span><span class="detail-value">' + (job.category || 'N/A') + '</span></div>';
    html += '</div></div>';
    
    html += '<div class="detail-section"><h3>Project Details</h3><div class="detail-grid">';
    html += '<div class="detail-item"><span class="detail-label">Topic</span><span class="detail-value">' + (job.topic || 'N/A') + '</span></div>';
    html += '<div class="detail-item"><span class="detail-label">Word Count</span><span class="detail-value">' + (job.word_count || 'N/A') + '</span></div>';
    html += '<div class="detail-item"><span class="detail-label">Referencing Style</span><span class="detail-value">' + (job.referencing_style_display || 'N/A') + '</span></div>';
    html += '<div class="detail-item"><span class="detail-label">Writing Style</span><span class="detail-value">' + (job.writing_style_display || 'N/A') + '</span></div>';
    html += '<div class="detail-item"><span class="detail-label">Software</span><span class="detail-value">' + (job.software || 'N/A') + '</span></div>';
    html += '</div>';
    html += '<div class="detail-item" style="margin-top: 15px;"><span class="detail-label">Instructions</span><span class="detail-value">' + (job.instruction || 'N/A') + '</span></div>';
    html += '</div>';
    
    html += '<div class="detail-section"><h3>Allocation Details</h3><div class="detail-grid">';
    html += '<div class="detail-item"><span class="detail-label">Allocated By</span><span class="detail-value">' + allocation.allocated_by_name + '</span></div>';
    html += '<div class="detail-item"><span class="detail-label">Start Date</span><span class="detail-value">' + allocation.start_date + '</span></div>';
    html += '<div class="detail-item"><span class="detail-label">End Date</span><span class="detail-value">' + allocation.end_date + '</span></div>';
    html += '<div class="detail-item"><span class="detail-label">Allocated At</span><span class="detail-value">' + allocation.allocated_at + '</span></div>';
    html += '</div>';
    if (allocation.notes) {
        html += '<div class="detail-item" style="margin-top: 15px;"><span class="detail-label">Notes</span><span class="detail-value">' + allocation.notes + '</span></div>';
    }
    html += '</div>';
    
    if (attachments && attachments.length > 0) {
        html += '<div class="detail-section"><h3>üìé Attachments (' + attachments.length + ')</h3><ul class="attachment-list">';
        attachments.forEach(function(attachment) {
            html += '<li class="attachment-item"><div class="attachment-info"><svg class="attachment-icon" width="20" height="20" viewBox="0 0 24 24" fill="none"><path d="M13 2H6C5.46957 2 4.96086 2.21071 4.58579 4.58579C4.21071 2.96086 4 3.46957 4 4V20C4 20.5304 4.21071 21.0391 4.58579 21.4142C4.96086 21.7893 5.46957 22 6 22H18C18.5304 22 19.0391 21.7893 19.4142 21.4142C19.7893 21.0391 20 20.5304 20 20V9L13 2Z" stroke="currentColor" stroke-width="2"/><path d="M13 2V9H20" stroke="currentColor" stroke-width="2"/></svg>';
            html += '<div class="attachment-details"><span class="attachment-name" title="' + attachment.original_filename + '">' + attachment.original_filename + '</span>';
            html += '<span class="attachment-size">' + attachment.file_size + '</span></div></div>';
            html += '<div class="attachment-download"><a href="' + attachment.file_url + '" download class="download-btn"><svg viewBox="0 0 24 24" fill="none"><path d="M21 15V19C21 19.5304 20.7893 20.0391 20.4142 20.4142C20.0391 20.7893 19.5304 21 19 21H5C4.46957 21 3.96086 20.7893 3.58579 20.4142C3.21071 20.0391 3 19.5304 3 19V15" stroke="currentColor" stroke-width="2"/><path d="M7 10L12 15L17 10" stroke="currentColor" stroke-width="2"/><path d="M12 15V3" stroke="currentColor" stroke-width="2"/></svg>Download</a></div></li>';
        });
        html += '</ul></div>';
    }
    
    return html;
}

// Close modals on outside click
window.onclick = function(event) {
    if (event.target.classList.contains('modal')) {
        event.target.style.display = 'none';
    }
}

// Auto-expand submission blocks
document.addEventListener('DOMContentLoaded', function() {
    document.querySelectorAll('[id^="submission-row-"]').forEach(function(row) {
        row.style.display = 'table-row';  // Always show the submission blocks
        const systemId = row.id.replace('submission-row-', '');
        loadSubmissionDetails(systemId);
    });
});

</script>
{% endblock %}