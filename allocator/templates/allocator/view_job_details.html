{% extends 'base.html' %}
{% load static %}
{% block title %}Job Details - {{ job.masking_id }}{% endblock %}
{% block extra_css %}
<style>
/* Modern Professional Design */
.job-details-wrapper {
    max-width: 1600px;
    margin: 0 auto;
    padding: 2rem 1rem;
}

/* Hero Header Section */
.page-hero {
    background: linear-gradient(135deg, rgba(78, 205, 196, 0.1) 0%, rgba(68, 163, 161, 0.05) 100%);
    border-radius: 16px;
    padding: 2.5rem;
    margin-bottom: 2.5rem;
    border: 1px solid rgba(78, 205, 196, 0.2);
    position: relative;
    overflow: hidden;
}

.page-hero::before {
    content: '';
    position: absolute;
    top: -50%;
    right: -10%;
    width: 400px;
    height: 400px;
    background: radial-gradient(circle, rgba(78, 205, 196, 0.15) 0%, transparent 70%);
    border-radius: 50%;
    pointer-events: none;
}

.hero-content {
    position: relative;
    z-index: 1;
}

.hero-title {
    font-size: 2.5rem;
    font-weight: 700;
    margin-bottom: 0.75rem;
    background: linear-gradient(135deg, #4ecdc4 0%, #44a3a1 100%);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
}

.hero-meta {
    display: flex;
    gap: 2rem;
    flex-wrap: wrap;
    margin-top: 1rem;
}

.hero-meta-item {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    color: rgba(255, 255, 255, 0.8);
    font-size: 0.95rem;
}

.hero-meta-label {
    color: rgba(255, 255, 255, 0.6);
    font-size: 0.85rem;
    text-transform: uppercase;
    letter-spacing: 0.05em;
}

.hero-actions {
    margin-top: 1.5rem;
    display: flex;
    gap: 1rem;
    flex-wrap: wrap;
}

/* Single Card Layout */
.unified-card {
    background: rgba(255, 255, 255, 0.03);
    border-radius: 16px;
    border: 1px solid rgba(255, 255, 255, 0.1);
    overflow: hidden;
    transition: all 0.3s ease;
    margin-bottom: 2rem;
}

.unified-card:hover {
    border-color: rgba(78, 205, 196, 0.4);
    box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
}

.card-header-unified {
    background: linear-gradient(135deg, rgba(78, 205, 196, 0.15) 0%, rgba(68, 163, 161, 0.08) 100%);
    padding: 2rem;
    border-bottom: 1px solid rgba(78, 205, 196, 0.2);
}

.card-title-main {
    font-size: 1.5rem;
    font-weight: 600;
    margin: 0;
    color: #fff;
}

.card-body-unified {
    padding: 2rem;
}

/* Status Badge */
.status-badge {
    display: inline-flex;
    align-items: center;
    padding: 0.5rem 1.25rem;
    border-radius: 50px;
    background: rgba(78, 205, 196, 0.2);
    border: 2px solid rgba(78, 205, 196, 0.4);
    color: var(--primary);
    font-weight: 700;
    font-size: 0.9rem;
    text-transform: uppercase;
    letter-spacing: 0.08em;
}

/* Info Grid */
.info-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
    gap: 1.5rem;
    margin-bottom: 2.5rem;
}

.info-box {
    background: rgba(255, 255, 255, 0.04);
    padding: 1.5rem;
    border-radius: 12px;
    border: 1px solid rgba(255, 255, 255, 0.08);
    transition: all 0.3s ease;
}

.info-box:hover {
    background: rgba(255, 255, 255, 0.06);
    border-color: rgba(78, 205, 196, 0.3);
    transform: scale(1.02);
}

.info-label {
    font-size: 0.75rem;
    text-transform: uppercase;
    letter-spacing: 0.1em;
    color: rgba(255, 255, 255, 0.5);
    margin-bottom: 0.5rem;
    display: block;
}

.info-content {
    font-size: 1.1rem;
    font-weight: 600;
    color: #fff;
}

/* Section Headers */
.section-header {
    font-size: 1.1rem;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.1em;
    color: rgba(78, 205, 196, 0.9);
    margin-bottom: 1.5rem;
    padding-bottom: 0.75rem;
    border-bottom: 2px solid rgba(78, 205, 196, 0.3);
}

/* Section Divider */
.section-divider {
    margin: 2.5rem 0;
    border: none;
    height: 1px;
    background: linear-gradient(90deg, transparent 0%, rgba(78, 205, 196, 0.3) 50%, transparent 100%);
}

/* Instruction Block */
.instruction-block {
    background: linear-gradient(135deg, rgba(78, 205, 196, 0.08) 0%, rgba(68, 163, 161, 0.04) 100%);
    border-left: 4px solid rgba(78, 205, 196, 0.6);
    padding: 1.5rem;
    border-radius: 8px;
    margin-bottom: 2.5rem;
}

.instruction-text {
    color: rgba(255, 255, 255, 0.8);
    line-height: 1.7;
    white-space: pre-line;
    font-size: 0.95rem;
}

/* File List Modern */
.files-container {
    margin-bottom: 2.5rem;
}

.files-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 1.5rem;
}

.files-count {
    background: rgba(78, 205, 196, 0.15);
    color: var(--primary);
    padding: 0.25rem 0.75rem;
    border-radius: 20px;
    font-size: 0.85rem;
    font-weight: 600;
}

.file-item {
    display: flex;
    align-items: center;
    justify-content: space-between;
    background: rgba(255, 255, 255, 0.04);
    padding: 1.25rem 1.5rem;
    border-radius: 12px;
    border: 1px solid rgba(255, 255, 255, 0.08);
    margin-bottom: 1rem;
    transition: all 0.3s ease;
}

.file-item:hover {
    background: rgba(255, 255, 255, 0.07);
    border-color: rgba(78, 205, 196, 0.4);
    transform: translateX(8px);
}

.file-info {
    flex: 1;
}

.file-name {
    font-weight: 600;
    font-size: 1rem;
    color: #fff;
    margin-bottom: 0.25rem;
}

.file-source {
    font-size: 0.85rem;
    color: rgba(255, 255, 255, 0.5);
}

.file-actions {
    display: flex;
    align-items: center;
    gap: 1rem;
}

.file-date {
    font-size: 0.85rem;
    color: rgba(255, 255, 255, 0.6);
}

/* Empty State */
.empty-state {
    text-align: center;
    padding: 3rem 2rem;
    color: rgba(255, 255, 255, 0.5);
    font-style: italic;
}

/* Button Styles */
.btn {
    padding: 0.75rem 1.5rem;
    border-radius: 8px;
    font-weight: 600;
    text-decoration: none;
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
    transition: all 0.3s ease;
    font-size: 0.9rem;
}

.btn-light {
    background: rgba(255, 255, 255, 0.1);
    color: #fff;
    border: 1px solid rgba(255, 255, 255, 0.2);
}

.btn-light:hover {
    background: rgba(255, 255, 255, 0.15);
    border-color: rgba(255, 255, 255, 0.3);
}

.btn-outline {
    background: transparent;
    color: var(--primary);
    border: 2px solid rgba(78, 205, 196, 0.4);
}

.btn-outline:hover {
    background: rgba(78, 205, 196, 0.1);
    border-color: var(--primary);
}

.btn-sm {
    padding: 0.5rem 1rem;
    font-size: 0.85rem;
}

/* Responsive Design */
@media (max-width: 768px) {
    .page-hero {
        padding: 1.5rem;
    }
    
    .hero-title {
        font-size: 1.75rem;
    }
    
    .hero-meta {
        flex-direction: column;
        gap: 0.75rem;
    }
    
    .hero-actions {
        flex-direction: column;
    }
    
    .hero-actions .btn {
        width: 100%;
        justify-content: center;
    }
    
    .info-grid {
        grid-template-columns: 1fr;
    }
    
    .card-header-unified,
    .card-body-unified {
        padding: 1.5rem;
    }
}

/* Animation */
.fade-in {
    animation: fadeInUp 0.6s ease-out;
}

@keyframes fadeInUp {
    from {
        opacity: 0;
        transform: translateY(20px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}
</style>
{% endblock %}
{% block content %}
<div class="fade-in job-details-wrapper">
    <!-- Hero Header -->
    <div class="page-hero">
        <div class="hero-content">
            <h1 class="hero-title">Job Details</h1>
            <div class="hero-meta">
                <div class="hero-meta-item">
                    <span class="hero-meta-label">System ID:</span>
                    <strong>{{ job.masking_id }}</strong>
                </div>
                {% if marketing_job %}
                <div class="hero-meta-item">
                    <span class="hero-meta-label">Job ID:</span>
                    <strong>{{ marketing_job.job_id }}</strong>
                </div>
                {% endif %}
            </div>
            <div class="hero-actions">
                <a href="{% url 'allocator_dashboard' %}" class="btn btn-light">&larr; Back to Dashboard</a>
                {% if marketing_job %}
                    <a href="{% url 'allocator_all_project_detail' marketing_job.system_id %}" class="btn btn-outline">View Posted Form</a>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- Unified Card -->
    <div class="unified-card">
        <div class="card-header-unified">
            <h3 class="card-title-main">Job Information</h3>
        </div>
        <div class="card-body-unified">
            <!-- Basic Information Grid -->
            <div class="info-grid">
                <div class="info-box">
                    <span class="info-label">Job ID</span>
                    <div class="info-content">{{ marketing_job.job_id|default:job.masking_id }}</div>
                </div>
                <div class="info-box">
                    <span class="info-label">Status</span>
                    <div class="info-content">
                        <span class="status-badge">
                            {{ job.get_status_display }}
                        </span>
                    </div>
                </div>
                <div class="info-box">
                    <span class="info-label">Created By</span>
                    <div class="info-content">
                        {% if marketing_job and marketing_job.created_by %}
                            {{ marketing_job.created_by.get_full_name|default:marketing_job.created_by.email }}
                        {% elif job.created_by %}
                            {{ job.created_by.get_full_name|default:job.created_by.email }}
                        {% else %}
                            --
                        {% endif %}
                    </div>
                </div>
                {% if marketing_job %}
                {% comment %} <div class="info-box">
                    <span class="info-label">Marketing Status</span>
                    <div class="info-content">
                        <span class="status-badge" id="marketing-status-display">{{ marketing_job.get_status_display }}</span>
                    </div>
                </div> {% endcomment %}
                {% endif %}
            </div>

            <!-- Additional Details -->
            {% if primary_info %}
                <h4 class="section-header">Project Details</h4>
                <div class="info-grid">
                    {% for item in primary_info %}
                        <div class="info-box">
                            <span class="info-label">{{ item.label }}</span>
                            <div class="info-content">{{ item.value|default:'--' }}</div>
                        </div>
                    {% endfor %}
                </div>
            {% endif %}

            <!-- Instruction Section -->
            <hr class="section-divider">
            <h4 class="section-header">Instruction</h4>
            <div class="instruction-block">
                <div class="instruction-text">{{ instructions_text|default:'No instruction available.' }}</div>
            </div>

            <!-- Task Allocations Section -->
            {% if show_task_allocations %}
            <hr class="section-divider">
            <h4 class="section-header">Task Allocations</h4>
            
            {% for panel in task_panels %}
                {% if panel.allocations %}
                <div style="margin-bottom: 2rem;">
                    <h5 style="font-size: 1.1rem; font-weight: 600; color: rgba(78, 205, 196, 0.9); margin-bottom: 1rem; text-transform: uppercase; letter-spacing: 0.05em;">{{ panel.label }}</h5>
                    
                    {% for allocation in panel.allocations %}
                    <div class="info-grid" style="margin-bottom: 1.5rem;">
                        <div class="info-box">
                            <span class="info-label">
                                {% if allocation.task_type == 'content_creation' %}
                                    Assigned Writer
                                {% elif allocation.task_type == 'ai_plag' %}
                                    Assigned Process Member
                                {% elif allocation.task_type == 'decoration' %}
                                    Assigned To
                                {% else %}
                                    Assigned To
                                {% endif %}
                            </span>
                            <div class="info-content">
                                {% if allocation.allocated_to %}
                                    {% if allocation.task_type == 'content_creation' and allocation.allocated_to.role != 'writer' %}
                                        <div style="color: rgba(255, 100, 100, 0.9);">{{ allocation.allocated_to.get_full_name|default:allocation.allocated_to.email }}</div>
                                        <div style="font-size: 0.75rem; color: rgba(255, 100, 100, 0.9); margin-top: 0.25rem;">
                                            ⚠️ {{ allocation.allocated_to.get_role_display|default:allocation.allocated_to.role }} (Expected: Writer)
                                        </div>
                                        <div style="font-size: 0.7rem; color: rgba(255, 150, 100, 0.8); margin-top: 0.5rem; font-style: italic;">
                                            Note: Wrong role assigned. Please reassign to a writer.
                                        </div>
                                    {% elif allocation.task_type == 'ai_plag' and allocation.allocated_to.role != 'process' %}
                                        <div style="color: rgba(255, 100, 100, 0.9);">{{ allocation.allocated_to.get_full_name|default:allocation.allocated_to.email }}</div>
                                        <div style="font-size: 0.75rem; color: rgba(255, 100, 100, 0.9); margin-top: 0.25rem;">
                                            ⚠️ {{ allocation.allocated_to.get_role_display|default:allocation.allocated_to.role }} (Expected: Process)
                                        </div>
                                        <div style="font-size: 0.7rem; color: rgba(255, 150, 100, 0.8); margin-top: 0.5rem; font-style: italic;">
                                            Note: Wrong role assigned. Please reassign to a process member.
                                        </div>
                                    {% else %}
                                        <div>{{ allocation.allocated_to.get_full_name|default:allocation.allocated_to.email }}</div>
                                        <div style="font-size: 0.75rem; color: rgba(78, 205, 196, 0.8); margin-top: 0.25rem;">
                                            {{ allocation.allocated_to.get_role_display|default:allocation.allocated_to.role }}
                                        </div>
                                    {% endif %}
                                {% else %}
                                    <div style="color: rgba(255, 100, 100, 0.9);">Not Assigned</div>
                                    <div style="font-size: 0.7rem; color: rgba(255, 150, 100, 0.8); margin-top: 0.5rem; font-style: italic;">
                                        No team member assigned to this task
                                    </div>
                                {% endif %}
                            </div>
                        </div>
                        <div class="info-box">
                            <span class="info-label">Start Date & Time</span>
                            <div class="info-content">
                                {% if allocation.start_date_time %}
                                    {{ allocation.start_date_time|date:"d M Y H:i" }}
                                {% else %}
                                    --
                                {% endif %}
                            </div>
                        </div>
                        <div class="info-box">
                            <span class="info-label">End Date & Time</span>
                            <div class="info-content">
                                {% if allocation.end_date_time %}
                                    {{ allocation.end_date_time|date:"d M Y H:i" }}
                                {% else %}
                                    --
                                {% endif %}
                            </div>
                        </div>
                        <div class="info-box">
                            <span class="info-label">Allocation Status</span>
                            <div class="info-content">
                                <span class="status-badge" style="background: rgba(78, 205, 196, 0.2); border-color: rgba(78, 205, 196, 0.4);">
                                    {{ allocation.get_status_display|default:allocation.status }}
                                </span>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
                {% endif %}
            {% endfor %}
            {% endif %}

            <!-- Attachments Section -->
            <hr class="section-divider">
            <div class="files-container">
                <div class="files-header">
                    <h4 class="section-header" style="margin: 0; border: none; padding: 0;">Attachments</h4>
                    <span class="files-count">{{ attachments|length }} Files</span>
                </div>
                {% if attachments %}
                    {% for attachment in attachments %}
                    <div class="file-item">
                        <div class="file-info">
                            <div class="file-name">{{ attachment.name }}</div>
                            <div class="file-source">Source: {{ attachment.source }}</div>
                        </div>
                        <div class="file-actions">
                            <span class="file-date">
                                {% if attachment.uploaded_at %}
                                    {{ attachment.uploaded_at|date:"d M Y" }}
                                {% else %}
                                    --
                                {% endif %}
                            </span>
                            {% if attachment.url %}
                                <a href="{{ attachment.url }}" target="_blank" class="btn btn-sm btn-outline">Open</a>
                            {% else %}
                                <span class="btn btn-sm" style="opacity: 0.5; cursor: not-allowed; border: 1px solid rgba(255,255,255,0.2); background: rgba(255,255,255,0.04); color: rgba(255,255,255,0.6);">Unavailable</span>
                            {% endif %}
                        </div>
                    </div>
                    {% endfor %}
                {% else %}
                    <div class="empty-state">No attachments uploaded for this job.</div>
                {% endif %}
            </div>

            <!-- Writer Submissions Section (Only for Process/In Review Status) -->
            {% if marketing_job.status in 'process|in_review' and writer_submissions %}
            <hr class="section-divider">
            <div class="files-container">
                <div class="files-header">
                    <h4 class="section-header" style="margin: 0; border: none; padding: 0;">Writer Submissions</h4>
                    <span class="files-count">{{ writer_submissions|length }} Submission(s)</span>
                </div>
                
                {% for submission in writer_submissions %}
                <div style="background: rgba(78, 205, 196, 0.05); border-radius: 12px; padding: 1.5rem; margin-bottom: 1.5rem; border: 1px solid rgba(78, 205, 196, 0.15);">
                    <!-- Submission Header -->
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem; flex-wrap: wrap; gap: 1rem;">
                        <div>
                            <div style="font-weight: 600; font-size: 1rem; color: #4ecdc4;">{{ submission.type_display }}</div>
                            <div style="font-size: 0.875rem; opacity: 0.7;">Submitted by: <strong>{{ submission.submitted_by }}</strong></div>
                        </div>
                        <div style="display: flex; gap: 1rem; align-items: center;">
                            <div style="text-align: right;">
                                <div style="font-size: 0.875rem;">{{ submission.submitted_at|date:"d M Y H:i" }}</div>
                                <span class="status-tag" style="background-color: 
                                    {% if submission.status == 'submitted' %}rgba(76, 175, 80, 0.2); color: #4CAF50
                                    {% elif submission.status == 'approved' %}rgba(33, 150, 243, 0.2); color: #2196F3
                                    {% elif submission.status == 'rejected' %}rgba(244, 67, 54, 0.2); color: #F44336
                                    {% else %}rgba(255, 152, 0, 0.2); color: #FF9800
                                    {% endif %};">
                                    {{ submission.status|title }}
                                </span>
                            </div>
                        </div>
                    </div>

                    <!-- Submission Files -->
                    {% if submission.files %}
                    <div style="margin-top: 1rem;">
                        {% for file in submission.files %}
                        <div style="display: flex; justify-content: space-between; align-items: center; padding: 1rem; background: rgba(255, 255, 255, 0.03); border-radius: 8px; margin-bottom: 0.75rem; border: 1px solid rgba(255, 255, 255, 0.05);">
                            <div style="flex: 1;">
                                <div style="font-weight: 500;">{{ file.name }}</div>
                                <div style="font-size: 0.75rem; opacity: 0.6;">
                                    {% if file.size %}
                                        {{ file.size|filesizeformat }}
                                    {% endif %}
                                    • Uploaded: {{ file.uploaded_at|date:"d M Y H:i" }}
                                </div>
                            </div>
                            <div>
                                {% if file.url %}
                                    <a href="{{ file.url }}" target="_blank" class="btn btn-sm btn-outline" style="padding: 0.5rem 1rem; font-size: 0.875rem;">Download</a>
                                {% else %}
                                    <span class="btn btn-sm" style="opacity: 0.5; cursor: not-allowed; padding: 0.5rem 1rem; font-size: 0.875rem;">Unavailable</span>
                                {% endif %}
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                    {% else %}
                    <div style="padding: 1rem; text-align: center; opacity: 0.6;">
                        <p>No files submitted for this {{ submission.type_display|lower }}</p>
                    </div>
                    {% endif %}
                </div>
                {% endfor %}
            </div>
            {% endif %}
        </div>
    </div>
</div>

<script>
// Refresh marketing job status on page load
document.addEventListener('DOMContentLoaded', function() {
    const jobMaskingId = '{{ job.masking_id }}';
    if (jobMaskingId && document.getElementById('marketing-status-display')) {
        // Fetch the latest job status from the server
        fetch(`/allocator/job-status/${jobMaskingId}/`)
            .then(response => response.json())
            .then(data => {
                const statusDisplay = document.getElementById('marketing-status-display');
                if (statusDisplay && data.marketing_status) {
                    statusDisplay.textContent = data.marketing_status;
                }
            })
            .catch(error => console.log('Status refresh skipped'));
    }
});
</script>
{% endblock %}
